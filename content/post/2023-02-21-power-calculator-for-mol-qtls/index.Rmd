---
title: Power calculator for  mol QTLs
author: Haky Im
date: '2023-02-21'
slug: power-calculator-for-mol-qtls
categories:
  - how to
tags: []
editor_options: 
  chunk_output_type: console
---


## PORS power calculation

The success of the prediction training depends mostly on whether the corresponding QTL study will be powered. Thus, we provide here the power to detect molecular QTLs for a range of sample sizes, effect sizes, and minor allele frequencies.


## function: R2 to beta and sig2epsi
```{r}
get_beta_and_sig2epsi = function(r2, sig2Y, maf) {
  # r2: proportion of variation explained by SNP
  # sig2Y: variance of trait
  # maf: minor allele frequency of SNP
  # it returns a list of beta and variance of noise term
  
  ## effect size is calculated from r2 = beta^2 *2*maf*(1-maf)
  beta = sqrt( r2 * sig2Y / (2 * maf * (1 - maf)) )
  sig2epsi = sig2Y * (1 - r2)
  return(list(beta = beta, sig2epsi = sig2epsi))
}
```

## function: R2 from beta assuming variance of y = 1
$$y = \delta \cdot x + \epsilon$$

$$r^2 = \delta^2 \cdot \text{var}(x) = \delta^2 \cdot 2 \cdot \text{maf} \cdot (1-\text{maf})$$
```{r}
```


```{r}

mafvec = c(0.05, 0.10, 0.30) 
effvec = c(0.40, 0.60, 0.80) 
nvec = c(200,350,500) 
nsnps = 1000

## install.packages("pwr")
if (!("pwr" %in% installed.packages()[, 1])) {
  install.packages("pwr")
}
```


## create data frame with all combinations
```{r}
library(tidyverse)
library(knitr)

alpha = 0.05/nsnps
mat = matrix(NA,length(mafvec)*length(effvec)*length(nvec),4)
colnames(mat) = c("maf","eff","nsam","power")
cont = 1
for(maf in mafvec)
{
  for(nn in nvec)
  {
    for(eff in effvec)
    {
      r2 = eff^2 * 2 * maf * (1-maf)
      rr = sqrt(r2)
      pp = pwr::pwr.r.test(n = nn, r= rr , sig.level = alpha)
      mat[cont,] = c(maf, eff, nn, pp$power)
      cont = cont + 1
    }
  }
}

mat %>% data.frame() %>% 
  pivot_wider(names_from = nsam, values_from = power) %>% 
  mutate(across(3:ncol(.), ~sprintf("%.1f%%", . * 100))) %>% 
  kable(format = "markdown", align = c("l", "l", "c", "c", "c"), 
        caption = "Power by sample size") 


```

